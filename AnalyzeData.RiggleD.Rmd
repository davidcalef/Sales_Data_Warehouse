
---
title: "Sales Analysis"
subtitle: "2020-2023"
author: "David Riggle"
date: "Summer 2024"
output: 
  html_document:
    self_contained: true
    toc: true
    toc_depth: 2
---

```{r setup, include=FALSE}
# Load required libraries
library(DBI)
library(RMySQL)
library(ggplot2)
library(kableExtra)
library(rprojroot)


# MySQL database connection details
mysql_host <- "sql5.freemysqlhosting.net"
mysql_dbname <- "sql5722857"
mysql_user <- "sql5722857"
mysql_password <- 
mysql_port <- 3306


# Set knit directory to the project folder
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())


# Connect to MySQL database
con_mysql <- dbConnect(
  RMySQL::MySQL(),
  dbname = mysql_dbname,
  host = mysql_host,
  port = mysql_port,
  user = mysql_user,
  password = mysql_password
)


```
## Analytical Query I: Top Five Products with the Most Sales
Top five products that generated most revenue across all years. Helpful for understanding which products are the most lucrative.
```{r, echo=FALSE}
# Analytical Query I: Top five products with the most sales
query_i <- dbGetQuery(con_mysql, "
  SELECT product_name, SUM(quantity * unit_cost) as total_revenue
  FROM sales_facts
  GROUP BY product_name
  ORDER BY total_revenue DESC
  LIMIT 5;
")

# Display the query results
print(query_i)

# Visualize the top products
ggplot(query_i, aes(x = reorder(product_name, -total_revenue), y = total_revenue, fill = product_name)) +
  geom_bar(stat = "identity") +
  labs(title = "Top Five Products by Revenue", x = "Product Name", y = "Total Revenue") +
  theme_minimal() +
  theme(legend.position = "none")
```
## Analytical Query II: Total Revenue and Total Units Sold per Product per Quarter
Breakdown of total revenue and units sold for each product by quarter is shown. Can help to explain seasonal trends and product performance over different periods.
```{r, echo=FALSE}
# Analytical Query II: Total revenue and total units sold per product per quarter
query_ii <- dbGetQuery(con_mysql, "
  SELECT 
    product_name, 
    QUARTER(sale_date) as quarter,
    YEAR(sale_date) as year,
    SUM(quantity * unit_cost) as total_revenue,
    SUM(quantity) as total_units_sold
  FROM sales_facts
  GROUP BY product_name, year, quarter
  ORDER BY year, quarter;
")

# Display the query results
print(query_ii)

# Visualize total revenue per product per quarter
ggplot(query_ii, aes(x = factor(quarter), y = total_revenue, fill = product_name)) +
  geom_bar(stat = "identity", position = "dodge") +
  facet_wrap(~ year, ncol = 1) +
  labs(title = "Total Revenue per Product per Quarter", x = "Quarter", y = "Total Revenue") +
  theme_minimal()
```
## Analytical Query III: Total Revenue per Product per Country
Revenue generated by each product across different countries. Regional preferences and geographic distribution of sales can be seen.
```{r, echo=FALSE}
# Analytical Query III: Total revenue per product per country
query_iii <- dbGetQuery(con_mysql, "
  SELECT 
    product_name, 
    country,
    SUM(quantity * unit_cost) as total_revenue
  FROM sales_facts
  JOIN customers_dim ON sales_facts.customer_id = customers_dim.customer_id
  GROUP BY product_name, country
  ORDER BY total_revenue DESC;
")

# Display the query results
print(query_iii)

# Visualize total revenue per product per country
ggplot(query_iii, aes(x = reorder(country, -total_revenue), y = total_revenue, color = product_name, group = product_name)) +
  geom_line(linewidth = 1) +
  geom_point(size = 2) +
  labs(title = "Total Revenue per Product per Country", x = "Country", y = "Total Revenue") +
  theme_minimal()
```
## Analytical Query IV: Average Sales per Sales Rep for Each Quarter
Performance of sales representatives shown calculating the average sales per quarter. Gives insight about which reps are performers.
```{r, echo=FALSE}
# Analytical Query IV: Average sales per sales rep for each quarter
query_iv <- dbGetQuery(con_mysql, "
  SELECT 
    CONCAT(first_name, ' ', last_name) as rep_name,
    QUARTER(sale_date) as quarter,
    YEAR(sale_date) as year,
    AVG(quantity * unit_cost) as average_sales
  FROM sales_facts
  JOIN reps_dim ON sales_facts.rep_id = reps_dim.rep_id
  GROUP BY rep_name, year, quarter
  ORDER BY rep_name, year, quarter;
")

# Display the query results
print(query_iv)

# Visualize average sales per sales rep using kableExtra
kable(query_iv, caption = "Average Sales per Sales Rep for Each Quarter") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"))
```
 Close the database connection
```{r, include=FALSE}
dbDisconnect(con_mysql)
```
